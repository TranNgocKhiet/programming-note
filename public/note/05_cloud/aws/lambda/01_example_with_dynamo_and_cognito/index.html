<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.152.2">
    <meta name="generator" content="Relearn 8.2.0+220806ce3ced8264fbdd693f77f28216a8a1b6ae">
    <meta name="description" content="import boto3 import json import os # Create client and handler dynamodb = boto3.resource(&#39;dynamodb&#39;) cognito_client = boto3.client(&#39;cognito-idp&#39;) # Get environment variables TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;) USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;) table = dynamodb.Table(TABLE_NAME) def build_update_params(updates): update_expression = &#34;SET &#34; expression_names = {} expression_values = {} # Use #name and #email to avoid reserved words attribute_map = { &#34;name&#34;: &#34;#name&#34;, &#34;email&#34;: &#34;#email&#34;, } for key, value in updates.items(): if key in attribute_map: placeholder = f&#34;:{key}&#34; attr_name = attribute_map[key] update_expression &#43;= f&#34;{attr_name} = {placeholder}, &#34; expression_values[placeholder] = value expression_names[attr_name] = key update_expression = update_expression.rstrip(&#34;, &#34;) return update_expression, expression_names, expression_values def lambda_handler(event, context): try: if &#34;body&#34; in event: body = json.loads(event[&#34;body&#34;]) else: body = event user_id = body.get(&#39;userId&#39;) updates = body.get(&#39;updates&#39;) if not user_id or not updates: return {&#39;statusCode&#39;: 400, &#39;body&#39;: &#39;L·ªói: Thi·∫øu &#34;userId&#34; ho·∫∑c &#34;updates&#34;&#39;} update_expr, attr_names, attr_values = build_update_params(updates) if not attr_values: return {&#39;statusCode&#39;: 400, &#39;body&#39;: &#39;Kh√¥ng c√≥ tr∆∞·ªùng h·ª£p l·ªá n√†o ƒë·ªÉ c·∫≠p nh·∫≠t&#39;} dynamo_response = table.update_item( Key={&#39;userId&#39;: user_id}, UpdateExpression=update_expr, ExpressionAttributeNames=attr_names, ExpressionAttributeValues=attr_values, ReturnValues=&#34;UPDATED_NEW&#34; ) if &#39;email&#39; in updates: new_email = updates[&#39;email&#39;] try: cognito_client.admin_update_user_attributes( UserPoolId=USER_POOL_ID, Username=user_id, UserAttributes=[ { &#39;Name&#39;: &#39;email&#39;, &#39;Value&#39;: new_email }, { &#39;Name&#39;: &#39;email_verified&#39;, &#39;Value&#39;: &#39;true&#39; } ] ) except Exception as e: print(f&#34;Cognito Error: {e}&#34;) return { &#39;statusCode&#39;: 500, &#39;body&#39;: f&#39;Update DynamoDB success, but failed to update Cognito: {str(e)}&#39; } success_body = { &#34;message&#34;: &#34;Update success&#34;, &#34;updatedAttributes&#34;: dynamo_response.get(&#39;Attributes&#39;) } return { &#39;statusCode&#39;: 200, &#39;body&#39;: json.dumps(success_body) } except Exception as e: print(f&#34;Unknow error: {e}&#34;) return { &#39;statusCode&#39;: 500, &#39;body&#39;: f&#39;Error when handle request: {str(e)}&#39; }Declare and initializeimport boto3 import json import os dynamodb = boto3.resource(&#39;dynamodb&#39;) cognito_client = boto3.client(&#39;cognito-idp&#39;) TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;) USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;) table = dynamodb.Table(TABLE_NAME)import boto3: Th∆∞ vi·ªán (SDK) ch√≠nh th·ª©c c·ªßa AWS cho Python, d√πng ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi c√°c AWS Service import json: D√πng ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu JSON (v√≠ d·ª•: event[&#34;body&#34;]) import os: D√πng ƒë·ªÉ ƒë·ªçc c√°c Environment variables trong Configuration c·ªßa Lambda dynamodb = boto3.resource(&#39;dynamodb&#39;): S·ª≠ d·ª•ng giao di·ªán ‚Äúresource‚Äù (c·∫•p cao, d·ªÖ d√πng h∆°n) c·ªßa boto3 cho DynamoDB cognito_client = boto3.client(&#39;cognito-idp&#39;): S·ª≠ d·ª•ng giao di·ªán ‚Äúclient‚Äù (c·∫•p th·∫•p, chi ti·∫øt h∆°n) cho Cognito Identity Provider TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;): T√™n c·ªßa b·∫£ng DynamoDB ch·ª©a th√¥ng tin ng∆∞·ªùi d√πng USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;): ID c·ªßa Cognito User Pool n∆°i ng∆∞·ªùi d√πng ƒë∆∞·ª£c qu·∫£n l√Ω table = dynamodb.Table(TABLE_NAME): T·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng Table c·ª• th·ªÉ t·ª´ dynamodb resource, tr·ªè ƒë·∫øn b·∫£ng c√≥ t√™n l√† TABLE_NAME. ƒêi·ªÅu n√†y gi√∫p th·ª±c hi·ªán c√°c thao t√°c (nh∆∞ update_item) tr·ª±c ti·∫øp tr√™n b·∫£ng ƒë√≥ build_update_params Functiondef build_update_params(updates):: Khai b√°o t√™n h√†m, t√™n tham s·ªë update_expression = &#34;SET &#34;: Chu·ªói l·ªánh SET cho DynamoDB (v√≠ d·ª•: SET #name = :name, #email = :email) expression_names = {}: M·ªôt dictionary ƒë·ªÉ map t√™n gi·ªØ ch·ªó (placeholder) v·ªõi t√™n thu·ªôc t√≠nh th·∫≠t. V√≠ d·ª•: {&#34;#name&#34;: &#34;name&#34;}. ƒêi·ªÅu n√†y r·∫•t quan tr·ªçng ƒë·ªÉ tr√°nh l·ªói v·ªõi c√°c t·ª´ kh√≥a d·ª± tr·ªØ (reserved words) c·ªßa DynamoDB (nh∆∞ name) expression_values = {}: M·ªôt dictionary ƒë·ªÉ map t√™n gi·ªØ ch·ªó v·ªõi gi√° tr·ªã th·∫≠t. V√≠ d·ª•: {&#34;:name&#34;: &#34;John Doe&#34;}. ƒêi·ªÅu n√†y gi√∫p ngƒÉn ng·ª´a l·ªói SQL injection (m·∫∑c d√π ƒë√¢y l√† NoSQL, nguy√™n t·∫Øc t∆∞∆°ng t·ª±) attribute_map = { &#34;name&#34;: &#34;#name&#34;, &#34;email&#34;: &#34;#email&#34;, }ƒê·ªãnh nghƒ©a m·ªôt attribute_map. N√≥ ch·ªâ ƒë·ªãnh r·∫±ng n·∫øu updates c√≥ ch·ª©a ‚Äúname‚Äù ho·∫∑c ‚Äúemail‚Äù, ch√∫ng ta s·∫Ω s·ª≠ d·ª•ng t√™n gi·ªØ ch·ªó l√† #name v√† #email trong UpdateExpression for key, value in updates.items(): if key in attribute_map: placeholder = f&#34;:{key}&#34; attr_name = attribute_map[key] update_expression &#43;= f&#34;{attr_name} = {placeholder}, &#34; expression_values[placeholder] = value expression_names[attr_name] = keyfor key, value in updates.items():: L·∫∑p qua t·ª´ng c·∫∑p key (t√™n tr∆∞·ªùng) v√† value (gi√° tr·ªã m·ªõi) trong dictionary updates m√† ng∆∞·ªùi d√πng g·ª≠i l√™n">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Example with Dynamo and Cognito using Python :: IT From Scratch">
    <meta name="twitter:description" content="import boto3 import json import os # Create client and handler dynamodb = boto3.resource(&#39;dynamodb&#39;) cognito_client = boto3.client(&#39;cognito-idp&#39;) # Get environment variables TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;) USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;) table = dynamodb.Table(TABLE_NAME) def build_update_params(updates): update_expression = &#34;SET &#34; expression_names = {} expression_values = {} # Use #name and #email to avoid reserved words attribute_map = { &#34;name&#34;: &#34;#name&#34;, &#34;email&#34;: &#34;#email&#34;, } for key, value in updates.items(): if key in attribute_map: placeholder = f&#34;:{key}&#34; attr_name = attribute_map[key] update_expression &#43;= f&#34;{attr_name} = {placeholder}, &#34; expression_values[placeholder] = value expression_names[attr_name] = key update_expression = update_expression.rstrip(&#34;, &#34;) return update_expression, expression_names, expression_values def lambda_handler(event, context): try: if &#34;body&#34; in event: body = json.loads(event[&#34;body&#34;]) else: body = event user_id = body.get(&#39;userId&#39;) updates = body.get(&#39;updates&#39;) if not user_id or not updates: return {&#39;statusCode&#39;: 400, &#39;body&#39;: &#39;L·ªói: Thi·∫øu &#34;userId&#34; ho·∫∑c &#34;updates&#34;&#39;} update_expr, attr_names, attr_values = build_update_params(updates) if not attr_values: return {&#39;statusCode&#39;: 400, &#39;body&#39;: &#39;Kh√¥ng c√≥ tr∆∞·ªùng h·ª£p l·ªá n√†o ƒë·ªÉ c·∫≠p nh·∫≠t&#39;} dynamo_response = table.update_item( Key={&#39;userId&#39;: user_id}, UpdateExpression=update_expr, ExpressionAttributeNames=attr_names, ExpressionAttributeValues=attr_values, ReturnValues=&#34;UPDATED_NEW&#34; ) if &#39;email&#39; in updates: new_email = updates[&#39;email&#39;] try: cognito_client.admin_update_user_attributes( UserPoolId=USER_POOL_ID, Username=user_id, UserAttributes=[ { &#39;Name&#39;: &#39;email&#39;, &#39;Value&#39;: new_email }, { &#39;Name&#39;: &#39;email_verified&#39;, &#39;Value&#39;: &#39;true&#39; } ] ) except Exception as e: print(f&#34;Cognito Error: {e}&#34;) return { &#39;statusCode&#39;: 500, &#39;body&#39;: f&#39;Update DynamoDB success, but failed to update Cognito: {str(e)}&#39; } success_body = { &#34;message&#34;: &#34;Update success&#34;, &#34;updatedAttributes&#34;: dynamo_response.get(&#39;Attributes&#39;) } return { &#39;statusCode&#39;: 200, &#39;body&#39;: json.dumps(success_body) } except Exception as e: print(f&#34;Unknow error: {e}&#34;) return { &#39;statusCode&#39;: 500, &#39;body&#39;: f&#39;Error when handle request: {str(e)}&#39; }Declare and initializeimport boto3 import json import os dynamodb = boto3.resource(&#39;dynamodb&#39;) cognito_client = boto3.client(&#39;cognito-idp&#39;) TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;) USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;) table = dynamodb.Table(TABLE_NAME)import boto3: Th∆∞ vi·ªán (SDK) ch√≠nh th·ª©c c·ªßa AWS cho Python, d√πng ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi c√°c AWS Service import json: D√πng ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu JSON (v√≠ d·ª•: event[&#34;body&#34;]) import os: D√πng ƒë·ªÉ ƒë·ªçc c√°c Environment variables trong Configuration c·ªßa Lambda dynamodb = boto3.resource(&#39;dynamodb&#39;): S·ª≠ d·ª•ng giao di·ªán ‚Äúresource‚Äù (c·∫•p cao, d·ªÖ d√πng h∆°n) c·ªßa boto3 cho DynamoDB cognito_client = boto3.client(&#39;cognito-idp&#39;): S·ª≠ d·ª•ng giao di·ªán ‚Äúclient‚Äù (c·∫•p th·∫•p, chi ti·∫øt h∆°n) cho Cognito Identity Provider TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;): T√™n c·ªßa b·∫£ng DynamoDB ch·ª©a th√¥ng tin ng∆∞·ªùi d√πng USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;): ID c·ªßa Cognito User Pool n∆°i ng∆∞·ªùi d√πng ƒë∆∞·ª£c qu·∫£n l√Ω table = dynamodb.Table(TABLE_NAME): T·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng Table c·ª• th·ªÉ t·ª´ dynamodb resource, tr·ªè ƒë·∫øn b·∫£ng c√≥ t√™n l√† TABLE_NAME. ƒêi·ªÅu n√†y gi√∫p th·ª±c hi·ªán c√°c thao t√°c (nh∆∞ update_item) tr·ª±c ti·∫øp tr√™n b·∫£ng ƒë√≥ build_update_params Functiondef build_update_params(updates):: Khai b√°o t√™n h√†m, t√™n tham s·ªë update_expression = &#34;SET &#34;: Chu·ªói l·ªánh SET cho DynamoDB (v√≠ d·ª•: SET #name = :name, #email = :email) expression_names = {}: M·ªôt dictionary ƒë·ªÉ map t√™n gi·ªØ ch·ªó (placeholder) v·ªõi t√™n thu·ªôc t√≠nh th·∫≠t. V√≠ d·ª•: {&#34;#name&#34;: &#34;name&#34;}. ƒêi·ªÅu n√†y r·∫•t quan tr·ªçng ƒë·ªÉ tr√°nh l·ªói v·ªõi c√°c t·ª´ kh√≥a d·ª± tr·ªØ (reserved words) c·ªßa DynamoDB (nh∆∞ name) expression_values = {}: M·ªôt dictionary ƒë·ªÉ map t√™n gi·ªØ ch·ªó v·ªõi gi√° tr·ªã th·∫≠t. V√≠ d·ª•: {&#34;:name&#34;: &#34;John Doe&#34;}. ƒêi·ªÅu n√†y gi√∫p ngƒÉn ng·ª´a l·ªói SQL injection (m·∫∑c d√π ƒë√¢y l√† NoSQL, nguy√™n t·∫Øc t∆∞∆°ng t·ª±) attribute_map = { &#34;name&#34;: &#34;#name&#34;, &#34;email&#34;: &#34;#email&#34;, }ƒê·ªãnh nghƒ©a m·ªôt attribute_map. N√≥ ch·ªâ ƒë·ªãnh r·∫±ng n·∫øu updates c√≥ ch·ª©a ‚Äúname‚Äù ho·∫∑c ‚Äúemail‚Äù, ch√∫ng ta s·∫Ω s·ª≠ d·ª•ng t√™n gi·ªØ ch·ªó l√† #name v√† #email trong UpdateExpression for key, value in updates.items(): if key in attribute_map: placeholder = f&#34;:{key}&#34; attr_name = attribute_map[key] update_expression &#43;= f&#34;{attr_name} = {placeholder}, &#34; expression_values[placeholder] = value expression_names[attr_name] = keyfor key, value in updates.items():: L·∫∑p qua t·ª´ng c·∫∑p key (t√™n tr∆∞·ªùng) v√† value (gi√° tr·ªã m·ªõi) trong dictionary updates m√† ng∆∞·ªùi d√πng g·ª≠i l√™n">
    <meta property="og:url" content="/note/05_cloud/aws/lambda/01_example_with_dynamo_and_cognito/index.html">
    <meta property="og:site_name" content="IT From Scratch">
    <meta property="og:title" content="Example with Dynamo and Cognito using Python :: IT From Scratch">
    <meta property="og:description" content="import boto3 import json import os # Create client and handler dynamodb = boto3.resource(&#39;dynamodb&#39;) cognito_client = boto3.client(&#39;cognito-idp&#39;) # Get environment variables TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;) USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;) table = dynamodb.Table(TABLE_NAME) def build_update_params(updates): update_expression = &#34;SET &#34; expression_names = {} expression_values = {} # Use #name and #email to avoid reserved words attribute_map = { &#34;name&#34;: &#34;#name&#34;, &#34;email&#34;: &#34;#email&#34;, } for key, value in updates.items(): if key in attribute_map: placeholder = f&#34;:{key}&#34; attr_name = attribute_map[key] update_expression &#43;= f&#34;{attr_name} = {placeholder}, &#34; expression_values[placeholder] = value expression_names[attr_name] = key update_expression = update_expression.rstrip(&#34;, &#34;) return update_expression, expression_names, expression_values def lambda_handler(event, context): try: if &#34;body&#34; in event: body = json.loads(event[&#34;body&#34;]) else: body = event user_id = body.get(&#39;userId&#39;) updates = body.get(&#39;updates&#39;) if not user_id or not updates: return {&#39;statusCode&#39;: 400, &#39;body&#39;: &#39;L·ªói: Thi·∫øu &#34;userId&#34; ho·∫∑c &#34;updates&#34;&#39;} update_expr, attr_names, attr_values = build_update_params(updates) if not attr_values: return {&#39;statusCode&#39;: 400, &#39;body&#39;: &#39;Kh√¥ng c√≥ tr∆∞·ªùng h·ª£p l·ªá n√†o ƒë·ªÉ c·∫≠p nh·∫≠t&#39;} dynamo_response = table.update_item( Key={&#39;userId&#39;: user_id}, UpdateExpression=update_expr, ExpressionAttributeNames=attr_names, ExpressionAttributeValues=attr_values, ReturnValues=&#34;UPDATED_NEW&#34; ) if &#39;email&#39; in updates: new_email = updates[&#39;email&#39;] try: cognito_client.admin_update_user_attributes( UserPoolId=USER_POOL_ID, Username=user_id, UserAttributes=[ { &#39;Name&#39;: &#39;email&#39;, &#39;Value&#39;: new_email }, { &#39;Name&#39;: &#39;email_verified&#39;, &#39;Value&#39;: &#39;true&#39; } ] ) except Exception as e: print(f&#34;Cognito Error: {e}&#34;) return { &#39;statusCode&#39;: 500, &#39;body&#39;: f&#39;Update DynamoDB success, but failed to update Cognito: {str(e)}&#39; } success_body = { &#34;message&#34;: &#34;Update success&#34;, &#34;updatedAttributes&#34;: dynamo_response.get(&#39;Attributes&#39;) } return { &#39;statusCode&#39;: 200, &#39;body&#39;: json.dumps(success_body) } except Exception as e: print(f&#34;Unknow error: {e}&#34;) return { &#39;statusCode&#39;: 500, &#39;body&#39;: f&#39;Error when handle request: {str(e)}&#39; }Declare and initializeimport boto3 import json import os dynamodb = boto3.resource(&#39;dynamodb&#39;) cognito_client = boto3.client(&#39;cognito-idp&#39;) TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;) USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;) table = dynamodb.Table(TABLE_NAME)import boto3: Th∆∞ vi·ªán (SDK) ch√≠nh th·ª©c c·ªßa AWS cho Python, d√πng ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi c√°c AWS Service import json: D√πng ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu JSON (v√≠ d·ª•: event[&#34;body&#34;]) import os: D√πng ƒë·ªÉ ƒë·ªçc c√°c Environment variables trong Configuration c·ªßa Lambda dynamodb = boto3.resource(&#39;dynamodb&#39;): S·ª≠ d·ª•ng giao di·ªán ‚Äúresource‚Äù (c·∫•p cao, d·ªÖ d√πng h∆°n) c·ªßa boto3 cho DynamoDB cognito_client = boto3.client(&#39;cognito-idp&#39;): S·ª≠ d·ª•ng giao di·ªán ‚Äúclient‚Äù (c·∫•p th·∫•p, chi ti·∫øt h∆°n) cho Cognito Identity Provider TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;): T√™n c·ªßa b·∫£ng DynamoDB ch·ª©a th√¥ng tin ng∆∞·ªùi d√πng USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;): ID c·ªßa Cognito User Pool n∆°i ng∆∞·ªùi d√πng ƒë∆∞·ª£c qu·∫£n l√Ω table = dynamodb.Table(TABLE_NAME): T·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng Table c·ª• th·ªÉ t·ª´ dynamodb resource, tr·ªè ƒë·∫øn b·∫£ng c√≥ t√™n l√† TABLE_NAME. ƒêi·ªÅu n√†y gi√∫p th·ª±c hi·ªán c√°c thao t√°c (nh∆∞ update_item) tr·ª±c ti·∫øp tr√™n b·∫£ng ƒë√≥ build_update_params Functiondef build_update_params(updates):: Khai b√°o t√™n h√†m, t√™n tham s·ªë update_expression = &#34;SET &#34;: Chu·ªói l·ªánh SET cho DynamoDB (v√≠ d·ª•: SET #name = :name, #email = :email) expression_names = {}: M·ªôt dictionary ƒë·ªÉ map t√™n gi·ªØ ch·ªó (placeholder) v·ªõi t√™n thu·ªôc t√≠nh th·∫≠t. V√≠ d·ª•: {&#34;#name&#34;: &#34;name&#34;}. ƒêi·ªÅu n√†y r·∫•t quan tr·ªçng ƒë·ªÉ tr√°nh l·ªói v·ªõi c√°c t·ª´ kh√≥a d·ª± tr·ªØ (reserved words) c·ªßa DynamoDB (nh∆∞ name) expression_values = {}: M·ªôt dictionary ƒë·ªÉ map t√™n gi·ªØ ch·ªó v·ªõi gi√° tr·ªã th·∫≠t. V√≠ d·ª•: {&#34;:name&#34;: &#34;John Doe&#34;}. ƒêi·ªÅu n√†y gi√∫p ngƒÉn ng·ª´a l·ªói SQL injection (m·∫∑c d√π ƒë√¢y l√† NoSQL, nguy√™n t·∫Øc t∆∞∆°ng t·ª±) attribute_map = { &#34;name&#34;: &#34;#name&#34;, &#34;email&#34;: &#34;#email&#34;, }ƒê·ªãnh nghƒ©a m·ªôt attribute_map. N√≥ ch·ªâ ƒë·ªãnh r·∫±ng n·∫øu updates c√≥ ch·ª©a ‚Äúname‚Äù ho·∫∑c ‚Äúemail‚Äù, ch√∫ng ta s·∫Ω s·ª≠ d·ª•ng t√™n gi·ªØ ch·ªó l√† #name v√† #email trong UpdateExpression for key, value in updates.items(): if key in attribute_map: placeholder = f&#34;:{key}&#34; attr_name = attribute_map[key] update_expression &#43;= f&#34;{attr_name} = {placeholder}, &#34; expression_values[placeholder] = value expression_names[attr_name] = keyfor key, value in updates.items():: L·∫∑p qua t·ª´ng c·∫∑p key (t√™n tr∆∞·ªùng) v√† value (gi√° tr·ªã m·ªõi) trong dictionary updates m√† ng∆∞·ªùi d√πng g·ª≠i l√™n">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Programming Note">
    <meta itemprop="name" content="Example with Dynamo and Cognito using Python :: IT From Scratch">
    <meta itemprop="description" content="import boto3 import json import os # Create client and handler dynamodb = boto3.resource(&#39;dynamodb&#39;) cognito_client = boto3.client(&#39;cognito-idp&#39;) # Get environment variables TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;) USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;) table = dynamodb.Table(TABLE_NAME) def build_update_params(updates): update_expression = &#34;SET &#34; expression_names = {} expression_values = {} # Use #name and #email to avoid reserved words attribute_map = { &#34;name&#34;: &#34;#name&#34;, &#34;email&#34;: &#34;#email&#34;, } for key, value in updates.items(): if key in attribute_map: placeholder = f&#34;:{key}&#34; attr_name = attribute_map[key] update_expression &#43;= f&#34;{attr_name} = {placeholder}, &#34; expression_values[placeholder] = value expression_names[attr_name] = key update_expression = update_expression.rstrip(&#34;, &#34;) return update_expression, expression_names, expression_values def lambda_handler(event, context): try: if &#34;body&#34; in event: body = json.loads(event[&#34;body&#34;]) else: body = event user_id = body.get(&#39;userId&#39;) updates = body.get(&#39;updates&#39;) if not user_id or not updates: return {&#39;statusCode&#39;: 400, &#39;body&#39;: &#39;L·ªói: Thi·∫øu &#34;userId&#34; ho·∫∑c &#34;updates&#34;&#39;} update_expr, attr_names, attr_values = build_update_params(updates) if not attr_values: return {&#39;statusCode&#39;: 400, &#39;body&#39;: &#39;Kh√¥ng c√≥ tr∆∞·ªùng h·ª£p l·ªá n√†o ƒë·ªÉ c·∫≠p nh·∫≠t&#39;} dynamo_response = table.update_item( Key={&#39;userId&#39;: user_id}, UpdateExpression=update_expr, ExpressionAttributeNames=attr_names, ExpressionAttributeValues=attr_values, ReturnValues=&#34;UPDATED_NEW&#34; ) if &#39;email&#39; in updates: new_email = updates[&#39;email&#39;] try: cognito_client.admin_update_user_attributes( UserPoolId=USER_POOL_ID, Username=user_id, UserAttributes=[ { &#39;Name&#39;: &#39;email&#39;, &#39;Value&#39;: new_email }, { &#39;Name&#39;: &#39;email_verified&#39;, &#39;Value&#39;: &#39;true&#39; } ] ) except Exception as e: print(f&#34;Cognito Error: {e}&#34;) return { &#39;statusCode&#39;: 500, &#39;body&#39;: f&#39;Update DynamoDB success, but failed to update Cognito: {str(e)}&#39; } success_body = { &#34;message&#34;: &#34;Update success&#34;, &#34;updatedAttributes&#34;: dynamo_response.get(&#39;Attributes&#39;) } return { &#39;statusCode&#39;: 200, &#39;body&#39;: json.dumps(success_body) } except Exception as e: print(f&#34;Unknow error: {e}&#34;) return { &#39;statusCode&#39;: 500, &#39;body&#39;: f&#39;Error when handle request: {str(e)}&#39; }Declare and initializeimport boto3 import json import os dynamodb = boto3.resource(&#39;dynamodb&#39;) cognito_client = boto3.client(&#39;cognito-idp&#39;) TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;) USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;) table = dynamodb.Table(TABLE_NAME)import boto3: Th∆∞ vi·ªán (SDK) ch√≠nh th·ª©c c·ªßa AWS cho Python, d√πng ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi c√°c AWS Service import json: D√πng ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu JSON (v√≠ d·ª•: event[&#34;body&#34;]) import os: D√πng ƒë·ªÉ ƒë·ªçc c√°c Environment variables trong Configuration c·ªßa Lambda dynamodb = boto3.resource(&#39;dynamodb&#39;): S·ª≠ d·ª•ng giao di·ªán ‚Äúresource‚Äù (c·∫•p cao, d·ªÖ d√πng h∆°n) c·ªßa boto3 cho DynamoDB cognito_client = boto3.client(&#39;cognito-idp&#39;): S·ª≠ d·ª•ng giao di·ªán ‚Äúclient‚Äù (c·∫•p th·∫•p, chi ti·∫øt h∆°n) cho Cognito Identity Provider TABLE_NAME = os.environ.get(&#39;TABLE_NAME&#39;): T√™n c·ªßa b·∫£ng DynamoDB ch·ª©a th√¥ng tin ng∆∞·ªùi d√πng USER_POOL_ID = os.environ.get(&#39;USER_POOL_ID&#39;): ID c·ªßa Cognito User Pool n∆°i ng∆∞·ªùi d√πng ƒë∆∞·ª£c qu·∫£n l√Ω table = dynamodb.Table(TABLE_NAME): T·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng Table c·ª• th·ªÉ t·ª´ dynamodb resource, tr·ªè ƒë·∫øn b·∫£ng c√≥ t√™n l√† TABLE_NAME. ƒêi·ªÅu n√†y gi√∫p th·ª±c hi·ªán c√°c thao t√°c (nh∆∞ update_item) tr·ª±c ti·∫øp tr√™n b·∫£ng ƒë√≥ build_update_params Functiondef build_update_params(updates):: Khai b√°o t√™n h√†m, t√™n tham s·ªë update_expression = &#34;SET &#34;: Chu·ªói l·ªánh SET cho DynamoDB (v√≠ d·ª•: SET #name = :name, #email = :email) expression_names = {}: M·ªôt dictionary ƒë·ªÉ map t√™n gi·ªØ ch·ªó (placeholder) v·ªõi t√™n thu·ªôc t√≠nh th·∫≠t. V√≠ d·ª•: {&#34;#name&#34;: &#34;name&#34;}. ƒêi·ªÅu n√†y r·∫•t quan tr·ªçng ƒë·ªÉ tr√°nh l·ªói v·ªõi c√°c t·ª´ kh√≥a d·ª± tr·ªØ (reserved words) c·ªßa DynamoDB (nh∆∞ name) expression_values = {}: M·ªôt dictionary ƒë·ªÉ map t√™n gi·ªØ ch·ªó v·ªõi gi√° tr·ªã th·∫≠t. V√≠ d·ª•: {&#34;:name&#34;: &#34;John Doe&#34;}. ƒêi·ªÅu n√†y gi√∫p ngƒÉn ng·ª´a l·ªói SQL injection (m·∫∑c d√π ƒë√¢y l√† NoSQL, nguy√™n t·∫Øc t∆∞∆°ng t·ª±) attribute_map = { &#34;name&#34;: &#34;#name&#34;, &#34;email&#34;: &#34;#email&#34;, }ƒê·ªãnh nghƒ©a m·ªôt attribute_map. N√≥ ch·ªâ ƒë·ªãnh r·∫±ng n·∫øu updates c√≥ ch·ª©a ‚Äúname‚Äù ho·∫∑c ‚Äúemail‚Äù, ch√∫ng ta s·∫Ω s·ª≠ d·ª•ng t√™n gi·ªØ ch·ªó l√† #name v√† #email trong UpdateExpression for key, value in updates.items(): if key in attribute_map: placeholder = f&#34;:{key}&#34; attr_name = attribute_map[key] update_expression &#43;= f&#34;{attr_name} = {placeholder}, &#34; expression_values[placeholder] = value expression_names[attr_name] = keyfor key, value in updates.items():: L·∫∑p qua t·ª´ng c·∫∑p key (t√™n tr∆∞·ªùng) v√† value (gi√° tr·ªã m·ªõi) trong dictionary updates m√† ng∆∞·ªùi d√πng g·ª≠i l√™n">
    <meta itemprop="wordCount" content="1321">
    <title>Example with Dynamo and Cognito using Python :: IT From Scratch</title>
    <link href="../../../../../images/favicon.png?1763300029" rel="icon" type="image/png">
    <link href="../../../../../css/auto-complete/auto-complete.min.css?1763300029" rel="stylesheet">
    <script src="../../../../../js/auto-complete/auto-complete.min.js?1763300029" defer></script>
    <script src="../../../../../js/search-lunr.min.js?1763300029" defer></script>
    <script src="../../../../../js/search.min.js?1763300029" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="../../../../../searchindex.en.js?1763300029";
    </script>
    <script src="../../../../../js/lunr/lunr.min.js?1763300029" defer></script>
    <script src="../../../../../js/lunr/lunr.stemmer.support.min.js?1763300029" defer></script>
    <script src="../../../../../js/lunr/lunr.multi.min.js?1763300029" defer></script>
    <script src="../../../../../js/lunr/lunr.en.min.js?1763300029" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="../../../../../fonts/fontawesome/css/fontawesome-all.min.css?1763300029" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../../fonts/fontawesome/css/fontawesome-all.min.css?1763300029" rel="stylesheet"></noscript>
    <link href="../../../../../css/perfect-scrollbar/perfect-scrollbar.min.css?1763300029" rel="stylesheet">
    <link href="../../../../../css/theme.min.css?1763300029" rel="stylesheet">
    <link href="../../../../../css/format-html.min.css?1763300029" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/note\/05_cloud\/aws\/lambda\/01_example_with_dynamo_and_cognito\/index.html';
      window.relearn.relBasePath='..\/..\/..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..\/..\/..';
      window.relearn.absBaseUri='';
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy text to clipboard`;
      window.T_Copied_to_clipboard = `Text copied to clipboard!`;
      window.T_Link_copied_to_clipboard = `Link copied to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      window.T_Browser_unsupported_feature = `This browser doesn't support this feature`;
      // variant stuff
      window.relearn.themevariants = [ 'blue-dark', 'relearn-dark', 'relearn-light' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script>
  </head>
  <body class="mobile-support html" data-url="../../../../../note/05_cloud/aws/lambda/01_example_with_dynamo_and_cognito/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide">
<span class="btn cstyle button link noborder notitle interactive"><button onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button></span>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle button link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li><a href="#declare-and-initialize">Declare and initialize</a></li>
    <li><a href="#build_update_params-function">build_update_params Function</a></li>
    <li><a href="#lambda_handler-function">lambda_handler Function</a>
      <ul>
        <li><a href="#update-dynamodb">Update DynamoDB</a></li>
        <li><a href="#update-cognito">Update Cognito</a></li>
        <li><a href="#return-successs-and-catch-general-exception">Return Successs and catch general Exception</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="../../../../../index.html"><span itemprop="name">Home Page</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="../../../../../note/index.html"><span itemprop="name">Programming Note</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="../../../../../note/05_cloud/index.html"><span itemprop="name">Cloud</span></a><meta itemprop="position" content="3">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="../../../../../note/05_cloud/aws/index.html"><span itemprop="name">AWS</span></a><meta itemprop="position" content="4">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="../../../../../note/05_cloud/aws/lambda/index.html"><span itemprop="name">AWS Lambda</span></a><meta itemprop="position" content="5">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">With Dynamo and Cognito</span><meta itemprop="position" content="6"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle button link noborder notitle interactive"><a href="../../../../../note/05_cloud/aws/lambda/index.html" title="AWS Lambda (ü°ê)"><i class="fa-fw fas fa-chevron-left"></i></a></span>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle button link noborder notitle interactive"><a href="../../../../../note/06_office/index.html" title="Office (ü°í)"><i class="fa-fw fas fa-chevron-right"></i></a></span>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle button link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable note" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="example-with-dynamo-and-cognito-using-python">Example with Dynamo and Cognito using Python</h1>

<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> boto3
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create client and handler</span>
</span></span><span style="display:flex;"><span>dynamodb <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>resource(<span style="color:#e6db74">&#39;dynamodb&#39;</span>)
</span></span><span style="display:flex;"><span>cognito_client <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;cognito-idp&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get environment variables</span>
</span></span><span style="display:flex;"><span>TABLE_NAME <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;TABLE_NAME&#39;</span>)
</span></span><span style="display:flex;"><span>USER_POOL_ID <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;USER_POOL_ID&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>table <span style="color:#f92672">=</span> dynamodb<span style="color:#f92672">.</span>Table(TABLE_NAME)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_update_params</span>(updates):
</span></span><span style="display:flex;"><span>    update_expression <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SET &#34;</span>
</span></span><span style="display:flex;"><span>    expression_names <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    expression_values <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Use #name and #email to avoid reserved words</span>
</span></span><span style="display:flex;"><span>    attribute_map <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;#name&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;#email&#34;</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> updates<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> key <span style="color:#f92672">in</span> attribute_map:
</span></span><span style="display:flex;"><span>            placeholder <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;:</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            attr_name <span style="color:#f92672">=</span> attribute_map[key]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            update_expression <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>attr_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{</span>placeholder<span style="color:#e6db74">}</span><span style="color:#e6db74">, &#34;</span>
</span></span><span style="display:flex;"><span>            expression_values[placeholder] <span style="color:#f92672">=</span> value
</span></span><span style="display:flex;"><span>            expression_names[attr_name] <span style="color:#f92672">=</span> key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    update_expression <span style="color:#f92672">=</span> update_expression<span style="color:#f92672">.</span>rstrip(<span style="color:#e6db74">&#34;, &#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> update_expression, expression_names, expression_values
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;body&#34;</span> <span style="color:#f92672">in</span> event:
</span></span><span style="display:flex;"><span>            body <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(event[<span style="color:#e6db74">&#34;body&#34;</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            body <span style="color:#f92672">=</span> event
</span></span><span style="display:flex;"><span>                        
</span></span><span style="display:flex;"><span>        user_id <span style="color:#f92672">=</span> body<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;userId&#39;</span>)
</span></span><span style="display:flex;"><span>        updates <span style="color:#f92672">=</span> body<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;updates&#39;</span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user_id <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> updates:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">400</span>, <span style="color:#e6db74">&#39;body&#39;</span>: <span style="color:#e6db74">&#39;L·ªói: Thi·∫øu &#34;userId&#34; ho·∫∑c &#34;updates&#34;&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        update_expr, attr_names, attr_values <span style="color:#f92672">=</span> build_update_params(updates)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> attr_values:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">400</span>, <span style="color:#e6db74">&#39;body&#39;</span>: <span style="color:#e6db74">&#39;Kh√¥ng c√≥ tr∆∞·ªùng h·ª£p l·ªá n√†o ƒë·ªÉ c·∫≠p nh·∫≠t&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        dynamo_response <span style="color:#f92672">=</span> table<span style="color:#f92672">.</span>update_item(
</span></span><span style="display:flex;"><span>            Key<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;userId&#39;</span>: user_id},
</span></span><span style="display:flex;"><span>            UpdateExpression<span style="color:#f92672">=</span>update_expr,
</span></span><span style="display:flex;"><span>            ExpressionAttributeNames<span style="color:#f92672">=</span>attr_names,
</span></span><span style="display:flex;"><span>            ExpressionAttributeValues<span style="color:#f92672">=</span>attr_values,
</span></span><span style="display:flex;"><span>            ReturnValues<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UPDATED_NEW&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;email&#39;</span> <span style="color:#f92672">in</span> updates:
</span></span><span style="display:flex;"><span>            new_email <span style="color:#f92672">=</span> updates[<span style="color:#e6db74">&#39;email&#39;</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                cognito_client<span style="color:#f92672">.</span>admin_update_user_attributes(
</span></span><span style="display:flex;"><span>                    UserPoolId<span style="color:#f92672">=</span>USER_POOL_ID,
</span></span><span style="display:flex;"><span>                    Username<span style="color:#f92672">=</span>user_id, 
</span></span><span style="display:flex;"><span>                    UserAttributes<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;Name&#39;</span>: <span style="color:#e6db74">&#39;email&#39;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;Value&#39;</span>: new_email
</span></span><span style="display:flex;"><span>                        },
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;Name&#39;</span>: <span style="color:#e6db74">&#39;email_verified&#39;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;Value&#39;</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    ]
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Cognito Error: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;body&#39;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Update DynamoDB success, but failed to update Cognito: </span><span style="color:#e6db74">{</span>str(e)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        success_body <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Update success&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;updatedAttributes&#34;</span>: dynamo_response<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;Attributes&#39;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;body&#39;</span>: json<span style="color:#f92672">.</span>dumps(success_body)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Unknow error: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;body&#39;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Error when handle request: </span><span style="color:#e6db74">{</span>str(e)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>        }</span></span></code></pre></div>
<hr>
<h2 id="declare-and-initialize">Declare and initialize<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> boto3
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dynamodb <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>resource(<span style="color:#e6db74">&#39;dynamodb&#39;</span>)
</span></span><span style="display:flex;"><span>cognito_client <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;cognito-idp&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TABLE_NAME <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;TABLE_NAME&#39;</span>)
</span></span><span style="display:flex;"><span>USER_POOL_ID <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;USER_POOL_ID&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>table <span style="color:#f92672">=</span> dynamodb<span style="color:#f92672">.</span>Table(TABLE_NAME)</span></span></code></pre></div>
<ul>
<li><code>import boto3</code>: Th∆∞ vi·ªán (<strong>SDK</strong>) ch√≠nh th·ª©c c·ªßa <strong>AWS</strong> cho <strong>Python</strong>, d√πng ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi c√°c <strong>AWS Service</strong></li>
<li><code>import json</code>: D√πng ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu <strong>JSON</strong> (v√≠ d·ª•: <code>event[&quot;body&quot;]</code>)</li>
<li><code>import os</code>: D√πng ƒë·ªÉ ƒë·ªçc c√°c <strong>Environment variables</strong> trong <strong>Configuration</strong> c·ªßa <strong>Lambda</strong></li>
<li><code>dynamodb = boto3.resource('dynamodb')</code>: S·ª≠ d·ª•ng giao di·ªán &ldquo;resource&rdquo; (c·∫•p cao, d·ªÖ d√πng h∆°n) c·ªßa <code>boto3</code> cho <strong>DynamoDB</strong></li>
<li><code>cognito_client = boto3.client('cognito-idp')</code>: S·ª≠ d·ª•ng giao di·ªán &ldquo;client&rdquo; (c·∫•p th·∫•p, chi ti·∫øt h∆°n) cho <strong>Cognito Identity Provider</strong></li>
<li><code>TABLE_NAME = os.environ.get('TABLE_NAME')</code>: T√™n c·ªßa b·∫£ng <strong>DynamoDB</strong> ch·ª©a th√¥ng tin ng∆∞·ªùi d√πng</li>
<li><code>USER_POOL_ID = os.environ.get('USER_POOL_ID')</code>: ID c·ªßa <strong>Cognito User Pool</strong> n∆°i ng∆∞·ªùi d√πng ƒë∆∞·ª£c qu·∫£n l√Ω</li>
<li><code>table = dynamodb.Table(TABLE_NAME)</code>: T·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng <strong>Table</strong> c·ª• th·ªÉ t·ª´ dynamodb resource, tr·ªè ƒë·∫øn b·∫£ng c√≥ t√™n l√† <code>TABLE_NAME</code>. ƒêi·ªÅu n√†y gi√∫p th·ª±c hi·ªán c√°c thao t√°c (nh∆∞ <code>update_item</code>) tr·ª±c ti·∫øp tr√™n b·∫£ng ƒë√≥</li>
</ul>
<hr>
<h2 id="build_update_params-function">build_update_params Function<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<ul>
<li><code>def build_update_params(updates):</code>: Khai b√°o t√™n h√†m, t√™n tham s·ªë</li>
<li><code>update_expression = &quot;SET &quot;</code>: Chu·ªói l·ªánh <code>SET</code> cho <strong>DynamoDB</strong> (v√≠ d·ª•: <code>SET #name = :name, #email = :email</code>)</li>
<li><code>expression_names = {}</code>: M·ªôt dictionary ƒë·ªÉ map t√™n gi·ªØ ch·ªó (placeholder) v·ªõi t√™n thu·ªôc t√≠nh th·∫≠t. V√≠ d·ª•: <code>{&quot;#name&quot;: &quot;name&quot;}</code>. ƒêi·ªÅu n√†y r·∫•t quan tr·ªçng ƒë·ªÉ tr√°nh l·ªói v·ªõi c√°c t·ª´ kh√≥a d·ª± tr·ªØ (reserved words) c·ªßa <strong>DynamoDB</strong> (nh∆∞ <code>name</code>)</li>
<li><code>expression_values = {}</code>: M·ªôt dictionary ƒë·ªÉ map t√™n gi·ªØ ch·ªó v·ªõi gi√° tr·ªã th·∫≠t. V√≠ d·ª•: <code>{&quot;:name&quot;: &quot;John Doe&quot;}</code>. ƒêi·ªÅu n√†y gi√∫p ngƒÉn ng·ª´a l·ªói SQL injection (m·∫∑c d√π ƒë√¢y l√† <strong>NoSQL</strong>, nguy√™n t·∫Øc t∆∞∆°ng t·ª±)</li>
</ul>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>attribute_map <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;#name&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;#email&#34;</span>,
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<ul>
<li>ƒê·ªãnh nghƒ©a m·ªôt <code>attribute_map</code>. N√≥ ch·ªâ ƒë·ªãnh r·∫±ng n·∫øu <code>updates</code> c√≥ ch·ª©a &ldquo;name&rdquo; ho·∫∑c &ldquo;email&rdquo;, ch√∫ng ta s·∫Ω s·ª≠ d·ª•ng t√™n gi·ªØ ch·ªó l√† <code>#name</code> v√† <code>#email</code> trong <code>UpdateExpression</code></li>
</ul>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> updates<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> key <span style="color:#f92672">in</span> attribute_map:
</span></span><span style="display:flex;"><span>        placeholder <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;:</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        attr_name <span style="color:#f92672">=</span> attribute_map[key]
</span></span><span style="display:flex;"><span> ¬† ¬† ¬† ¬† ¬† ¬†
</span></span><span style="display:flex;"><span>        update_expression <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>attr_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{</span>placeholder<span style="color:#e6db74">}</span><span style="color:#e6db74">, &#34;</span>
</span></span><span style="display:flex;"><span>        expression_values[placeholder] <span style="color:#f92672">=</span> value
</span></span><span style="display:flex;"><span>        expression_names[attr_name] <span style="color:#f92672">=</span> key</span></span></code></pre></div>
<ul>
<li>
<p><code>for key, value in updates.items():</code>: L·∫∑p qua t·ª´ng c·∫∑p <code>key</code> (t√™n tr∆∞·ªùng) v√† <code>value</code> (gi√° tr·ªã m·ªõi) trong dictionary <code>updates</code> m√† ng∆∞·ªùi d√πng g·ª≠i l√™n</p>
</li>
<li>
<p><code>if key in attribute_map:</code>: (<strong>Quan tr·ªçng</strong>) Ch·ªâ x·ª≠ l√Ω n·∫øu <code>key</code> (v√≠ d·ª•: &ldquo;name&rdquo;) c√≥ trong <code>attribute_map</code>. N·∫øu ng∆∞·ªùi d√πng g·ª≠i m·ªôt tr∆∞·ªùng kh√¥ng c√≥ trong map (v√≠ d·ª•: <code>{&quot;age&quot;: 30}</code>), n√≥ s·∫Ω b·ªã b·ªè qua</p>
</li>
<li>
<p>N·∫øu tr∆∞·ªùng h·ª£p l·ªá:
<br>‚ÄÉ + <code>placeholder = f&quot;:{key}&quot;</code>: T·∫°o t√™n gi·ªØ ch·ªó cho gi√° tr·ªã (v√≠ d·ª•: <code>:name</code>)
<br>‚ÄÉ + <code>attr_name = attribute_map[key]1</code>: L·∫•y t√™n gi·ªØ ch·ªó cho thu·ªôc t√≠nh (v√≠ d·ª•: <code>#name</code>)
<br>‚ÄÉ + <code>update_expression += f&quot;{attr_name} = {placeholder}, &quot;</code>: Th√™m v√†o chu·ªói <code>update_expression</code> (v√≠ d·ª•: <code>SET #name = :name, </code> )
<br>‚ÄÉ + <code>expression_values[placeholder] = value</code>: Th√™m gi√° tr·ªã v√†o <code>expression_values</code> (v√≠ d·ª•: <code>{&quot;:name&quot;: &quot;John Doe&quot;}</code>)
<br>‚ÄÉ + <code>expression_names[attr_name] = key</code>: Th√™m t√™n v√†o <code>expression_names</code> (v√≠ d·ª•: <code>{&quot;#name&quot;: &quot;name&quot;}</code>)</p>
</li>
<li>
<p><code>update_expression = update_expression.rstrip(&quot;, &quot;)</code>: X√≥a d·∫•u ph·∫©y v√† kho·∫£ng tr·∫Øng th·ª´a ·ªü cu·ªëi chu·ªói <code>update_expression</code></p>
</li>
<li>
<p><code>return update_expression, expression_names, expression_values</code>: Tr·∫£ v·ªÅ 3 th√†nh ph·∫ßn ƒë√£ ƒë∆∞·ª£c x√¢y d·ª±ng</p>
</li>
</ul>
<hr>
<h2 id="lambda_handler-function">lambda_handler Function<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<h3 id="update-dynamodb">Update DynamoDB<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<ul>
<li><code>def lambda_handler(event, context):</code>: Khai b√°o t√™n h√†m, t√™n tham s·ªë</li>
<li><code>try:</code>: B·∫Øt ƒë·∫ßu m·ªôt kh·ªëi <code>try...except</code> l·ªõn ƒë·ªÉ b·∫Øt b·∫•t k·ª≥ l·ªói kh√¥ng mong mu·ªën n√†o</li>
</ul>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;body&#34;</span> <span style="color:#f92672">in</span> event:
</span></span><span style="display:flex;"><span>    body <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(event[<span style="color:#e6db74">&#34;body&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    body <span style="color:#f92672">=</span> event</span></span></code></pre></div>
<ul>
<li>
<p>X·ª≠ l√Ω <code>event</code>. N·∫øu <strong>Lambda</strong> n√†y ƒë∆∞·ª£c k√≠ch ho·∫°t b·ªüi <strong>API Gateway</strong>, d·ªØ li·ªáu POST/PUT s·∫Ω n·∫±m trong <code>event[&quot;body&quot;]</code> d∆∞·ªõi d·∫°ng m·ªôt chu·ªói JSON. C·∫ßn <code>json.loads</code> ƒë·ªÉ bi·∫øn n√≥ th√†nh dictionary. N·∫øu kh√¥ng, (v√≠ d·ª•: ch·∫°y test tr·ª±c ti·∫øp trong <strong>Lambda</strong>), event ch√≠nh l√† <code>body</code></p>
</li>
<li>
<p><code>user_id = body.get('userId')</code>: L·∫•y <code>userId</code></p>
</li>
<li>
<p><code>updates = body.get('updates')</code>: L·∫•y dictionary <code>updates</code></p>
</li>
</ul>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user_id <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> updates:
</span></span><span style="display:flex;"><span> ¬† ¬† ¬† ¬† ¬† ¬†<span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">400</span>, <span style="color:#e6db74">&#39;body&#39;</span>: <span style="color:#e6db74">&#39;L·ªói: Thi·∫øu &#34;userId&#34; ho·∫∑c &#34;updates&#34;&#39;</span>}</span></span></code></pre></div>
<ul>
<li>
<p>Ki·ªÉm tra xem <code>userId</code> v√† <code> updates</code> c√≥ t·ªìn t·∫°i kh√¥ng. N·∫øu thi·∫øu, tr·∫£ v·ªÅ l·ªói <code>400 Bad Request</code></p>
</li>
<li>
<p><code>update_expr, attr_names, attr_values = build_update_params(updates)</code>: G·ªçi h√†m <code>build_update_params</code> ƒë√£ gi·∫£i th√≠ch ·ªü tr√™n</p>
</li>
</ul>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> attr_values:
</span></span><span style="display:flex;"><span> ¬† ¬† ¬† ¬† ¬† ¬†<span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">400</span>, <span style="color:#e6db74">&#39;body&#39;</span>: <span style="color:#e6db74">&#39;Kh√¥ng c√≥ tr∆∞·ªùng h·ª£p l·ªá n√†o ƒë·ªÉ c·∫≠p nh·∫≠t&#39;</span>}</span></span></code></pre></div>
<ul>
<li>N·∫øu <code>attr_values</code> r·ªóng (nghƒ©a l√† ng∆∞·ªùi d√πng ƒë√£ g·ª≠i <code>updates</code> nh∆∞ng kh√¥ng ch·ª©a &ldquo;name&rdquo; hay &ldquo;email&rdquo;), tr·∫£ v·ªÅ l·ªói <code>400</code></li>
</ul>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>dynamo_response <span style="color:#f92672">=</span> table<span style="color:#f92672">.</span>update_item(
</span></span><span style="display:flex;"><span>    Key<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;userId&#39;</span>: user_id},
</span></span><span style="display:flex;"><span>    UpdateExpression<span style="color:#f92672">=</span>update_expr,
</span></span><span style="display:flex;"><span>    ExpressionAttributeNames<span style="color:#f92672">=</span>attr_names,
</span></span><span style="display:flex;"><span>¬†   ExpressionAttributeValues<span style="color:#f92672">=</span>attr_values,
</span></span><span style="display:flex;"><span>    ReturnValues<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UPDATED_NEW&#34;</span>
</span></span><span style="display:flex;"><span>)</span></span></code></pre></div>
<ul>
<li><code>dynamo_response = table.update_item()</code>: ƒê√¢y l√† l·ªánh ch√≠nh th·ª©c c·∫≠p nh·∫≠t <strong>DynamoDB</strong></li>
<li><code>Key={'userId': user_id}</code>: Ch·ªâ ƒë·ªãnh item n√†o c·∫ßn c·∫≠p nh·∫≠t (d·ª±a tr√™n <strong>Primary Key</strong>)</li>
<li>Cung c·∫•p 3 tham s·ªë ƒë√£ ƒë∆∞·ª£c t·∫°o ra b·ªüi h√†m <code>build_update_params</code></li>
<li><code>ReturnValues=&quot;UPDATED_NEW&quot;</code>: Y√™u c·∫ßu DynamoDB tr·∫£ v·ªÅ gi√° tr·ªã m·ªõi c·ªßa c√°c thu·ªôc t√≠nh v·ª´a ƒë∆∞·ª£c c·∫≠p nh·∫≠t</li>
</ul>
<hr>
<h3 id="update-cognito">Update Cognito<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;email&#39;</span> <span style="color:#f92672">in</span> updates:
</span></span><span style="display:flex;"><span>    new_email <span style="color:#f92672">=</span> updates[<span style="color:#e6db74">&#39;email&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        cognito_client<span style="color:#f92672">.</span>admin_update_user_attributes(
</span></span><span style="display:flex;"><span>            UserPoolId<span style="color:#f92672">=</span>USER_POOL_ID,
</span></span><span style="display:flex;"><span>            Username<span style="color:#f92672">=</span>user_id, 
</span></span><span style="display:flex;"><span>            UserAttributes<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>                { <span style="color:#e6db74">&#39;Name&#39;</span>: <span style="color:#e6db74">&#39;email&#39;</span>, <span style="color:#e6db74">&#39;Value&#39;</span>: new_email },
</span></span><span style="display:flex;"><span>                { <span style="color:#e6db74">&#39;Name&#39;</span>: <span style="color:#e6db74">&#39;email_verified&#39;</span>, <span style="color:#e6db74">&#39;Value&#39;</span>: <span style="color:#e6db74">&#39;true&#39;</span> }
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>¬† ¬†     )</span></span></code></pre></div>
<ul>
<li><code>if 'email' in updates:</code>: Ch·ªâ th·ª±c hi·ªán kh·ªëi n√†y n·∫øu email l√† m·ªôt trong c√°c tr∆∞·ªùng ƒë∆∞·ª£c y√™u c·∫ßu c·∫≠p nh·∫≠t</li>
<li><code>new_email = updates['email']</code>: L·∫•y ƒë·ªãa ch·ªâ email m·ªõi</li>
<li><code>try:</code>: B·∫Øt ƒë·∫ßu m·ªôt kh·ªëi ```try&hellip;except`` l·ªìng nhau. ƒêi·ªÅu n√†y r·∫•t quan tr·ªçng: n√≥ cho ph√©p b·∫Øt l·ªói <strong>Cognito</strong> m·ªôt c√°ch ri√™ng bi·ªát</li>
<li><code>cognito_client.admin_update_user_attributes()</code>: G·ªçi h√†m <code>admin_update_user_attributes</code> c·ªßa <strong>Cognito</strong></li>
<li><code>UserPoolId=USER_POOL_ID,</code>: Ch·ªâ ƒë·ªãnh <strong>UserPoolId</strong></li>
<li><code>Username=user_id,</code>: Ch·ªâ ƒë·ªãnh Username (trong Cognito, Username th∆∞·ªùng ch√≠nh l√† userId ho·∫∑c sub c·ªßa ng∆∞·ªùi d√πng)</li>
<li>C·∫≠p nh·∫≠t thu·ªôc t√≠nh <code>email</code> th√†nh gi√° tr·ªã m·ªõi, v√† ƒë·ªìng th·ªùi ƒë√°nh d·∫•u <code>email_verified</code> l√† <code>true</code>. ƒê√¢y l√† m·ªôt h√†nh ƒë·ªông &ldquo;admin&rdquo;, gi·∫£ ƒë·ªãnh r·∫±ng email do admin c·∫≠p nh·∫≠t l√† ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c</li>
</ul>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Cognito Error: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;body&#39;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Update DynamoDB success, but failed to update Cognito: </span><span style="color:#e6db74">{</span>str(e)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div>
<ul>
<li>N·∫øu c√≥ l·ªói x·∫£y ra ch·ªâ v·ªõi <strong>Cognito</strong> (v√≠ d·ª•: <code>email</code> kh√¥ng h·ª£p l·ªá, ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i trong <strong>Cognito</strong>), h√†m s·∫Ω d·ª´ng v√† tr·∫£ v·ªÅ l·ªói <strong>500</strong>, n√≥ n√≥i r√µ: &ldquo;Update DynamoDB success, but failed to update Cognito&rdquo;</li>
</ul>
<hr>
<h3 id="return-successs-and-catch-general-exception">Return Successs and catch general Exception<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>success_body <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Update success&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;updatedAttributes&#34;</span>: dynamo_response<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;Attributes&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;body&#39;</span>: json<span style="color:#f92672">.</span>dumps(success_body)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<ul>
<li>N·∫øu m·ªçi th·ª© ch·∫°y su√¥n s·∫ª (c·∫£ <strong>DynamoDB</strong> v√† <strong>Cognito</strong> (n·∫øu c√≥)), t·∫°o m·ªôt <code>body</code> ph·∫£n h·ªìi th√†nh c√¥ng. N√≥ bao g·ªìm c√°c thu·ªôc t√≠nh ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t l·∫•y t·ª´ <code>dynamo_response</code> (nh·ªù <code>ReturnValues=&quot;UPDATED_NEW&quot;</code>)</li>
<li>Tr·∫£ v·ªÅ ph·∫£n h·ªìi <code>200 OK</code> v·ªõi body ƒë√£ ƒë∆∞·ª£c chuy·ªÉn th√†nh chu·ªói <strong>JSON</strong></li>
</ul>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Unknow error: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;body&#39;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Error when handle request: </span><span style="color:#e6db74">{</span>str(e)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div>
<ul>
<li><code>except Exception as e:</code>: ƒê√¢y l√† kh·ªëi <code>except</code> c·ªßa <code>try</code> l·ªõn b√™n ngo√†i</li>
<li>N·∫øu c√≥ b·∫•t k·ª≥ l·ªói n√†o kh√°c x·∫£y ra (v√≠ d·ª•: l·ªói parse <strong>JSON</strong>, l·ªói <strong>DynamoDB</strong>, l·ªói <strong>Evironment variables</strong> b·ªã thi·∫øu&hellip;), n√≥ s·∫Ω b·ªã b·∫Øt ·ªü ƒë√¢y v√† tr·∫£ v·ªÅ l·ªói <code>500 Internal Server Error</code></li>
</ul>
<hr>

  <footer class="footline">
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
<a id="R-logo" href="../../../../../index.html" style="display:flex; gap: 1rem; ">
  <img src="../../../../../images/logo.png" alt="brand logo">
  <div class="logo-title" style="display: flex; justify-content: center; align-items: center; font-size: 1.5rem;">IT From Scratch</div>
</a>
        </div>
        <search><form action="../../../../../search/index.html" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
      </div>
      <div id="R-homelinks" class="default-animation">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="parent alwaysopen " data-nav-url="../../../../../note/index.html"><a class="padding" href="../../../../../note/index.html"><i class="far fa-sticky-note"></i> Programming Note</a><ul id="R-subsections-81b0aa1fb369232a7bc48846a5daf4d9" class="collapsible-menu">
            <li class="" data-nav-url="../../../../../note/01_programming-language/index.html"><a class="padding" href="../../../../../note/01_programming-language/index.html"><i class="fas fa-code"></i> Programming Language</a><ul id="R-subsections-c5aff2076aa8144a9a6847b47ae59b1d" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="../../../../../note/02_operating-system/index.html"><a class="padding" href="../../../../../note/02_operating-system/index.html"><i class="fas fa-compact-disc"></i> Operating System</a><ul id="R-subsections-72cabb372e9ddfd0ca9d90024a3ef5a5" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="../../../../../note/03_source-control/index.html"><a class="padding" href="../../../../../note/03_source-control/index.html"><i class="fas fa-code-branch"></i> Source Control</a><ul id="R-subsections-ac1d6927bbe9ff8c128e19c91ced14f0" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="../../../../../note/04_virtual-machine/index.html"><a class="padding" href="../../../../../note/04_virtual-machine/index.html"><i class="fas fa-vr-cardboard"></i> Virtual Machine</a><ul id="R-subsections-174921e347b3c11effb7c9f708890ddf" class="collapsible-menu"></ul></li>
            <li class="parent " data-nav-url="../../../../../note/05_cloud/index.html"><a class="padding" href="../../../../../note/05_cloud/index.html"><i class="fas fa-cloud"></i> Cloud</a><ul id="R-subsections-e5ca58342a8124a4e97c89f37782db22" class="collapsible-menu">
            <li class="parent " data-nav-url="../../../../../note/05_cloud/aws/index.html"><a class="padding" href="../../../../../note/05_cloud/aws/index.html"><i class="fab fa-aws"></i> AWS</a><ul id="R-subsections-22950c00d752d377cb55ee167f374578" class="collapsible-menu">
            <li class="parent " data-nav-url="../../../../../note/05_cloud/aws/lambda/index.html"><a class="padding" href="../../../../../note/05_cloud/aws/lambda/index.html">AWS Lambda</a><ul id="R-subsections-036e12aebdbb7d09e458800ed7507fef" class="collapsible-menu">
            <li class="active " data-nav-url="../../../../../note/05_cloud/aws/lambda/01_example_with_dynamo_and_cognito/index.html"><a class="padding" href="../../../../../note/05_cloud/aws/lambda/01_example_with_dynamo_and_cognito/index.html">With Dynamo and Cognito</a></li></ul></li></ul></li></ul></li>
            <li class="" data-nav-url="../../../../../note/06_office/index.html"><a class="padding" href="../../../../../note/06_office/index.html"><i class="fab fa-microsoft"></i> Office</a></li></ul></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <div class="nav-title padding">More</div>
          <ul class="space collapsible-menu">
            <li class="" data-nav-url="https://github.com/TranNgocKhiet"><a class="padding" href="https://github.com/TranNgocKhiet" rel="external"><i class="fab fa-github"></i> GitHub</a></li>
            <li class="" data-nav-url="https://www.linkedin.com/in/khiet-tran-61b163311/"><a class="padding" href="https://www.linkedin.com/in/khiet-tran-61b163311/" rel="external"><i class="fab fa-linkedin"></i> LinkedIn</a></li>
            <li class="" data-nav-url="mailto:slayersilver2005@gmail.com"><a class="padding" href="mailto:slayersilver2005@gmail.com" rel="external"><i class="fas fa-envelope"></i> slayersilver2005</a></li>
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
            <li class="R-variantswitcher">
              <div class="padding menu-control">
                <i class="fa-fw fas fa-paint-brush"></i>
                <span>&nbsp;</span>
                <div class="control-style">
                  <label class="a11y-only" for="R-select-variant">Theme</label>
                  <select id="R-select-variant">
                    <option id="R-select-variant-blue-dark" value="blue-dark" selected>Blue Dark</option>
                    <option id="R-select-variant-relearn-dark" value="relearn-dark">Relearn Dark</option>
                    <option id="R-select-variant-relearn-light" value="relearn-light">Relearn Light</option>
                  </select>
                </div>
                <div class="clear"></div>
              </div>
              <script>window.relearn.markVariant();</script>
            </li>
          </ul>
        </div>
<div id="R-footer"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script src="../../../../../js/perfect-scrollbar/perfect-scrollbar.min.js?1763300029" defer></script>
    <script src="../../../../../js/theme.min.js?1763300029" defer></script>
    <div id="toast-container" role="status" aria-live="polite" aria-atomic="false"></div>
  </body>
</html>
